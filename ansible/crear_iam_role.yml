---
- name: üîê Crear IAM Role para SSM usando AWS CLI
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    project_name: "cc-contenedores"
    aws_region: "us-east-1"

  tasks:
    - name: üìã Crear IAM Role usando AWS CLI
      shell: |
        aws iam create-role \
          --role-name "{{ project_name }}-ssm-role" \
          --assume-role-policy-document '{
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "ec2.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          }' \
          --description "Role para SSM en instancias EC2"
      register: create_role
      ignore_errors: yes

    - name: üîó Adjuntar pol√≠tica de SSM
      shell: |
        aws iam attach-role-policy \
          --role-name "{{ project_name }}-ssm-role" \
          --policy-arn "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
      ignore_errors: yes

    - name: üë§ Crear Instance Profile
      shell: |
        aws iam create-instance-profile \
          --instance-profile-name "{{ project_name }}-ssm-profile"
      ignore_errors: yes

    - name: üîÑ Asociar Role al Instance Profile
      shell: |
        aws iam add-role-to-instance-profile \
          --instance-profile-name "{{ project_name }}-ssm-profile" \
          --role-name "{{ project_name }}-ssm-role"
      ignore_errors: yes

    - name: ‚úÖ Verificar creaci√≥n
      shell: |
        echo "=== IAM Roles ==="
        aws iam list-roles --query 'Roles[?contains(RoleName, `{{ project_name }}`)].[RoleName]' --output table
        
        echo "=== Instance Profiles ==="
        aws iam list-instance-profiles --query 'InstanceProfiles[?contains(InstanceProfileName, `{{ project_name }}`)].[InstanceProfileName]' --output table
      register: verify

    - debug:
        var: verify.stdout
