---
- name: ğŸš€ Desplegar Infraestructura AWS y AplicaciÃ³n K8s
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    ansible_python_interpreter: /home/egrm23/miniconda3/bin/python3.13

  tasks:
    - name: ğŸ—ï¸ Gestionar VPC existente o crear nueva
      block:
        - name: Buscar VPC existente
          amazon.aws.ec2_vpc_net_info:
            region: "{{ aws_region }}"
            filters:
              "tag:Project": "{{ project_name }}"
          register: vpc_existente

        - name: Crear nueva VPC si no existe
          amazon.aws.ec2_vpc_net:
            name: "{{ project_name }}-vpc"
            cidr_block: "{{ vpc_cidr }}"
            region: "{{ aws_region }}"
            tags:
              Project: "{{ project_name }}"
          register: nueva_vpc
          when: vpc_existente.vpcs | length == 0

        - name: Configurar VPC ID
          set_fact:
            vpc_id: "{{ (vpc_existente.vpcs[0].vpc_id if vpc_existente.vpcs else nueva_vpc.vpc.id) }}"
            vpc_accion: "{{ 'reutilizada' if vpc_existente.vpcs else 'creada' }}"

      rescue:
        - name: ğŸš¨ Crear VPC de emergencia
          amazon.aws.ec2_vpc_net:
            name: "{{ project_name }}-vpc-emergencia"
            cidr_block: "10.99.0.0/16"
            region: "{{ aws_region }}"
            tags:
              Project: "{{ project_name }}"
          register: vpc_emergencia
          
        - name: Configurar VPC de emergencia
          set_fact:
            vpc_id: "{{ vpc_emergencia.vpc.id }}"
            vpc_accion: "emergencia"

    - name: ğŸ“ Estado de VPC
      debug:
        msg: "VPC: {{ vpc_id }} ({{ vpc_accion }})"

    - name: ğŸŒ Gestionar Internet Gateway
      block:
        - name: Verificar si la VPC ya tiene Internet Gateway
          amazon.aws.ec2_vpc_igw_info:
            region: "{{ aws_region }}"
            filters:
              "attachment.vpc-id": "{{ vpc_id }}"
          register: igw_existente

        - name: Crear Internet Gateway si no existe
          amazon.aws.ec2_vpc_igw:
            vpc_id: "{{ vpc_id }}"
            region: "{{ aws_region }}"
            tags:
              Project: "{{ project_name }}"
          when: igw_existente.internet_gateways | length == 0

      rescue:
        - debug:
            msg: "Internet Gateway podrÃ­a ya estar configurado"

    - name: ğŸ”— Gestionar Subnet
      block:
        - name: Buscar Subnets existentes en la VPC
          amazon.aws.ec2_vpc_subnet_info:
            region: "{{ aws_region }}"
            filters:
              vpc-id: "{{ vpc_id }}"
              "tag:Project": "{{ project_name }}"
          register: subnets_existentes

        - name: Crear Subnet si no existe
          amazon.aws.ec2_vpc_subnet:
            vpc_id: "{{ vpc_id }}"
            cidr: "{{ subnet_cidr }}"
            region: "{{ aws_region }}"
            az: "{{ aws_region }}a"
            map_public: true
            tags:
              Name: "{{ project_name }}-subnet"
              Project: "{{ project_name }}"
          register: subnet_info
          when: subnets_existentes.subnets | length == 0

        - name: Usar Subnet existente
          set_fact:
            subnet_id: "{{ subnets_existentes.subnets[0].id }}"
          when: subnets_existentes.subnets | length > 0

        - name: Usar Subnet nueva
          set_fact:
            subnet_id: "{{ subnet_info.subnet.id }}"
          when: subnets_existentes.subnets | length == 0

      rescue:
        - name: ğŸš¨ Crear Subnet de emergencia
          amazon.aws.ec2_vpc_subnet:
            vpc_id: "{{ vpc_id }}"
            cidr: "10.99.1.0/24"
            region: "{{ aws_region }}"
            az: "{{ aws_region }}a"
            map_public: true
            tags:
              Name: "{{ project_name }}-subnet-emergencia"
              Project: "{{ project_name }}"
          register: subnet_emergencia
          
        - name: Configurar Subnet de emergencia
          set_fact:
            subnet_id: "{{ subnet_emergencia.subnet.id }}"
    

      always:
        - pause:
            seconds: 5

    # - name: ğŸ›¡ï¸ Crear Security Group
    #   block:
    #     - name: Intentar crear Security Group
    #       command: >
    #         aws ec2 create-security-group
    #         --group-name "{{ project_name }}-sg"
    #         --description "Security group para la app"
    #         --vpc-id "{{ vpc_id }}"
    #         --region "{{ aws_region }}"
    #         --tag-specifications "ResourceType=security-group,Tags=[{Key=Project,Value={{ project_name }}}]"
    #       register: sg_cli

    #     - name: ğŸ“¥ Extraer Group ID
    #       set_fact:
    #         security_group_id: "{{ (sg_cli.stdout | from_json).GroupId }}"

    #     - name: ğŸ”’ Agregar regla SSH
    #       command: >
    #         aws ec2 authorize-security-group-ingress
    #         --group-id "{{ security_group_id }}"
    #         --protocol tcp
    #         --port 22
    #         --cidr 0.0.0.0/0
    #         --region "{{ aws_region }}"

    #     - name: ğŸŒ Agregar regla HTTP
    #       command: >
    #         aws ec2 authorize-security-group-ingress
    #         --group-id "{{ security_group_id }}"
    #         --protocol tcp
    #         --port 80
    #         --cidr 0.0.0.0/0
    #         --region "{{ aws_region }}"

    #     - name: ğŸ“¡ Agregar regla Backend
    #       command: >
    #         aws ec2 authorize-security-group-ingress
    #         --group-id "{{ security_group_id }}"
    #         --protocol tcp
    #         --port 3000
    #         --cidr 0.0.0.0/0
    #         --region "{{ aws_region }}"

    #     - name: ğŸ” Agregar regla HTTPS
    #       command: >
    #         aws ec2 authorize-security-group-ingress
    #         --group-id "{{ security_group_id }}"
    #         --protocol tcp
    #         --port 443
    #         --cidr 0.0.0.0/0
    #         --region "{{ aws_region }}"

    #     - name: ğŸ“ Guardar Security Group ID
    #       set_fact:
    #         security_group:
    #           group_id: "{{ security_group_id }}"

    - name: ğŸ›¡ï¸ Gestionar Security Group
      block:
        - name: Buscar Security Group existente
          amazon.aws.ec2_security_group_info:
            region: "{{ aws_region }}"
            filters:
              group-name: "{{ project_name }}-sg"
              vpc-id: "{{ vpc_id }}"
          register: sg_existente

        - name: Crear Security Group si no existe
          amazon.aws.ec2_security_group:
            name: "{{ project_name }}-sg"
            description: "Security group para la app"
            vpc_id: "{{ vpc_id }}"
            region: "{{ aws_region }}"
            tags:
              Project: "{{ project_name }}"
          register: sg_nuevo
          when: sg_existente.security_groups | length == 0

        - name: Configurar Security Group ID
          set_fact:
            security_group_id: "{{ (sg_existente.security_groups[0].group_id if sg_existente.security_groups else sg_nuevo.group_id) }}"
            security_group_action: "{{ 'reutilizado' if sg_existente.security_groups else 'creado' }}"

        - name: Mostrar informaciÃ³n del Security Group
          debug:
            msg: "Security Group {{ security_group_action }} con ID: {{ security_group_id }}"

    - name: ğŸš€ Crear Launch Template
      amazon.aws.ec2_launch_template:
        name: "{{ project_name }}-template"
        region: "{{ aws_region }}"
        image_id: "ami-0c02fb55956c7d316"  # Amazon Linux 2
        instance_type: "{{ instance_type }}"
        key_name: "{{ key_name }}"
        security_group_ids:
          - "{{ security_group_id }}"
        user_data: "{{ lookup('template', 'templates/user-data.sh.j2') | b64encode }}"
        block_device_mappings:
          - device_name: /dev/xvda
            ebs:
              volume_size: 8
              volume_type: gp2
        tags:
          Project: "{{ project_name }}"

    - name: ğŸ“ˆ Crear Auto Scaling Group
      amazon.aws.ec2_asg:
        name: "{{ project_name }}-asg"
        availability_zones:
          - "{{ aws_region }}a"
        launch_template:
          launch_template_name: "{{ project_name }}-template"
          version: "$Latest"
        min_size: "{{ min_size }}"
        max_size: "{{ max_size }}"
        desired_capacity: "{{ desired_capacity }}"
        vpc_zone_identifier:
          - "{{ subnet_id }}"
        
        tags:
          - key: Name
            value: "{{ project_name }}-instance"
            propagate_at_launch: true
          - key: Project
            value: "{{ project_name }}"
            propagate_at_launch: true
        wait_for_instances: false

    - name: âš™ï¸ Crear polÃ­ticas de escalado automÃ¡tico
      block:
        - name: ğŸ“Š Crear polÃ­tica de escalado por CPU alta
          community.aws.autoscaling_policy:
            name: "scale-up-high-cpu"
            state: present
            asg_name: "{{ project_name }}-asg"
            region: "{{ aws_region }}"
            adjustment_type: "ChangeInCapacity"
            scaling_adjustment: 1
            min_adjustment_step: 1
            cooldown: 60
          register: scale_up_policy

        - name: ğŸ“‰ Crear polÃ­tica de descenso por CPU baja
          community.aws.autoscaling_policy:
            name: "scale-down-low-cpu"
            state: present
            asg_name: "{{ project_name }}-asg"
            region: "{{ aws_region }}"
            adjustment_type: "ChangeInCapacity"
            scaling_adjustment: -1
            min_adjustment_step: 1
            cooldown: 300
          register: scale_down_policy

        - name: âœ… Confirmar creaciÃ³n de polÃ­ticas
          debug:
            msg: |
              âœ… PolÃ­ticas de Auto Scaling creadas:
              ğŸ“ˆ Escalado: {{ scale_up_policy.policy_name }} (ARN: {{ scale_up_policy.policy_arn }})
              ğŸ“‰ Descenso: {{ scale_down_policy.policy_name }} (ARN: {{ scale_down_policy.policy_arn }})

    - name: â³ Esperar a que las instancias estÃ©n en servicio
      amazon.aws.autoscaling_group:
        name: "{{ project_name }}-asg"
        region: "{{ aws_region }}"
        wait_for_instances: true
        wait_timeout: 600
      register: asg_wait_result
      when: min_size > 0

    - name: ğŸ”„ Esperar adicional para inicializaciÃ³n del sistema
      pause:
        minutes: 2
      when: min_size > 0
      
    - name: ğŸ” Obtener informaciÃ³n detallada del ASG
      amazon.aws.autoscaling_group_info:
        name: "{{ project_name }}-asg"
        region: "{{ aws_region }}"
      register: asg_info

    - name: ğŸ“Š Obtener informaciÃ³n de las instancias del ASG
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        filters:
          "tag:aws:autoscaling:groupName": "{{ project_name }}-asg"
      register: asg_instances_info
    
    # - name: ğŸ” DEBUG - Ver estructura de asg_instances_info
    #   debug:
    #     var: asg_instances_info

    - name: ğŸ‰ Mostrar informaciÃ³n de acceso (VERSIÃ“N SEGURA)
      debug:
        msg: |
          ğŸ‰ Â¡INFRAESTRUCTURA DESPLEGADA EXITOSAMENTE!

          âœ… Recursos creados:
          ğŸ”— VPC ID: {{ vpc_id }}
          ğŸ”— Subnet ID: {{ subnet_id }}
          ğŸ›¡ï¸ Security Group: {{ security_group_id }}
          ğŸ“ˆ Auto Scaling Group: {{ project_name }}-asg
          ğŸš€ Launch Template: {{ project_name }}-template

          {% if asg_info.results[0].instances | length > 0 %}
          ğŸ“Š Estado del ASG:
            Deseadas: {{ asg_info.results[0].desired_capacity }}
            MÃ­nimo: {{ asg_info.results[0].min_size }}
            MÃ¡ximo: {{ asg_info.results[0].max_size }}
            Instancias en servicio: {{ asg_info.results[0].instances | selectattr('lifecycle_state', 'equalto', 'InService') | list | length }}

          ğŸ“¡ IDs de instancias creadas:
            {% for instance in asg_info.results[0].instances %}
            - {{ instance.instance_id }} ({{ instance.lifecycle_state }})
            {% endfor %}

          ğŸ”— Para obtener las IPs y acceder:
            {% for instance in asg_info.results[0].instances %}
            aws ec2 describe-instances --instance-ids {{ instance.instance_id }} --region {{ aws_region }} --query 'Reservations[0].Instances[0].PublicIpAddress'
            {% endfor %}

          ğŸ’¡ Una vez tengas las IPs, accede a:
            Frontend: http://[IP_PUBLICA]
            Backend:  http://[IP_PUBLICA]/api

          {% else %}
          âš ï¸  No hay instancias en servicio actualmente.
          
          ğŸ” Para diagnosticar:
            aws autoscaling describe-scaling-activities --auto-scaling-group-name {{ project_name }}-asg --region {{ aws_region }} --max-items 5
          {% endif %}
