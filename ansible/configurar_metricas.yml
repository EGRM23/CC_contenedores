---
- name: üîî Configurar Alarmas de CloudWatch para Auto Scaling Autom√°tico
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    project_name: "cc-contenedores"
    aws_region: "us-east-1"

  tasks:
    - name: üìã Obtener ARN de pol√≠ticas usando AWS CLI
      ansible.builtin.shell:
        cmd: |
          aws autoscaling describe-policies \
            --auto-scaling-group-name "{{ project_name }}-asg" \
            --region "{{ aws_region }}" \
            --query 'ScalingPolicies[].PolicyARN' \
            --output text
      register: policy_arns_result

    - name: üíæ Guardar ARNs en variables
      set_fact:
        scale_up_policy_arn: "{{ policy_arns_result.stdout.split()[0] }}"
        scale_down_policy_arn: "{{ policy_arns_result.stdout.split()[1] }}"

    - name: üîç Verificar pol√≠ticas encontradas
      debug:
        msg: |
          Pol√≠ticas encontradas:
          - Escalado: {{ scale_up_policy_arn }}
          - Descenso: {{ scale_down_policy_arn }}

    - name: üî• Crear alarma de CPU alta (dispara escalado)
      community.aws.cloudwatch_metric_alarm:
        name: "high-cpu-{{ project_name }}-asg"
        region: "{{ aws_region }}"
        metric: "CPUUtilization"
        namespace: "AWS/EC2"
        statistic: "Average"
        comparison: "GreaterThanOrEqualToThreshold"
        threshold: 75.0
        period: 60
        evaluation_periods: 2
        unit: "Percent"
        description: "Escalar cuando CPU >= 75% por 2 minutos"
        alarm_actions: 
          - "{{ scale_up_policy_arn }}"
        dimensions:
          AutoScalingGroupName: "{{ project_name }}-asg"
      register: high_cpu_alarm

    - name: ‚ùÑÔ∏è Crear alarma de CPU baja (dispara descenso)
      community.aws.cloudwatch_metric_alarm:
        name: "low-cpu-{{ project_name }}-asg"
        region: "{{ aws_region }}"
        metric: "CPUUtilization"
        namespace: "AWS/EC2"
        statistic: "Average"
        comparison: "LessThanThreshold"
        threshold: 40.0
        period: 300
        evaluation_periods: 2
        unit: "Percent"
        description: "Reducir cuando CPU < 40% por 10 minutos"
        alarm_actions:
          - "{{ scale_down_policy_arn }}"
        dimensions:
          AutoScalingGroupName: "{{ project_name }}-asg"
      register: low_cpu_alarm

    - name: ‚úÖ Mostrar configuraci√≥n completada
      debug:
        msg: |
          ‚úÖ AUTO SCALING AUTOM√ÅTICO CONFIGURADO
          
          üîî Alarmas de CloudWatch creadas:
          üî• high-cpu-{{ project_name }}-asg 
            - CPU >= 75% por 2 minutos ‚Üí +1 instancia
          
          ‚ùÑÔ∏è low-cpu-{{ project_name }}-asg
            - CPU < 40% por 10 minutos ‚Üí -1 instancia
          
          ‚ö° El sistema ahora escalar√° autom√°ticamente
