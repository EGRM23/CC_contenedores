---
- name: ğŸ”§ Configurar kubectl para el cluster EKS
  shell: |
    aws eks update-kubeconfig \
      --name {{ eks_cluster_name }} \
      --region {{ aws_region }}
  register: kubeconfig
  
- debug:
    var: kubeconfig.stdout

- name: ğŸ” Verificar estado del cluster EKS
  shell: |
    aws eks describe-cluster \
      --name cc-contenedores-cluster \
      --region us-east-1 \
      --query 'cluster.status' \
      --output text
  register: cluster_status
  
- debug:
    var: cluster_status.stdout

- name: ğŸ” Verificar nodos disponibles
  shell: |
    kubectl get nodes -o wide
  register: nodes_status

- debug:
    var: nodes_status.stdout

- name: ğŸ”— Agregar repositorio Helm de Nginx Ingress
  shell: |
    helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
    helm repo update
  register: helm_repo
  ignore_errors: yes

- debug:
    var: helm_repo.stdout

- name: ğŸ§¹ Limpiar instalaciÃ³n previa de ingress (si existe)
  shell: |
    helm uninstall nginx-ingress -n ingress-nginx 2>/dev/null || echo "No existÃ­a previa instalaciÃ³n"
    kubectl delete namespace ingress-nginx --wait=false 2>/dev/null || echo "Namespace no existe"
  ignore_errors: yes

- name: â³ Esperar limpieza completa
  pause:
    seconds: 30

- name: ğŸ“¦ Instalar Nginx Ingress Controller (sin wait)
  shell: |
    helm upgrade --install nginx-ingress ingress-nginx/ingress-nginx \
      --namespace ingress-nginx \
      --create-namespace \
      --set controller.service.type=LoadBalancer \
      --set controller.publishService.enabled=true \
      --atomic
  register: helm_install
  ignore_errors: yes
  
- debug:
    var: helm_install.stdout

- name: â³ Esperar inicializaciÃ³n de pods (con verificaciÃ³n manual)
  shell: |
    echo "ğŸ”„ Iniciando monitoreo del Ingress Controller..."
    # Esperar mÃ¡ximo 10 minutos
    timeout 600 bash -c '
      while true; do
        READY=$(kubectl get deployment -n ingress-nginx nginx-ingress-ingress-nginx-controller -o jsonpath="{.status.readyReplicas}" 2>/dev/null || echo "0")
        DESIRED=$(kubectl get deployment -n ingress-nginx nginx-ingress-ingress-nginx-controller -o jsonpath="{.status.replicas}" 2>/dev/null || echo "0")
        
        if [ "$READY" -eq "$DESIRED" ] && [ "$DESIRED" -ge "1" ]; then
          echo "âœ… Controlador listo con $READY/$DESIRED rÃ©plicas"
          exit 0
        fi
        
        # Verificar si hay pods en error
        ERROR_PODS=$(kubectl get pods -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx --field-selector=status.phase=Failed -o name | wc -l)
        if [ "$ERROR_PODS" -gt "0" ]; then
          echo "âŒ Hay $ERROR_PODS pods en estado Failed"
          kubectl get pods -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
          exit 1
        fi
        
        echo "â³ Esperando controlador... ($READY/$DESIRED rÃ©plicas listas)"
        sleep 30
      done
    ' 
    EXIT_CODE=$?
    
    if [ $EXIT_CODE -eq 0 ]; then
      echo "ğŸ‰ Ingress Controller desplegado exitosamente"
    elif [ $EXIT_CODE -eq 124 ]; then
      echo "âš ï¸ Timeout alcanzado despuÃ©s de 10 minutos"
      echo "ğŸ“Š Estado actual:"
      kubectl get pods -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
    else
      echo "âŒ Error durante el monitoreo"
    fi
    
    exit $EXIT_CODE
  register: wait_result
  ignore_errors: yes

- debug:
    var: wait_result.stdout

- name: ğŸ” Verificar estado actual del ingress
  shell: |
    echo "=== DEPLOYMENTS ==="
    kubectl get deployments -n ingress-nginx
    echo ""
    echo "=== PODS ==="
    kubectl get pods -n ingress-nginx -o wide
    echo ""
    echo "=== SERVICES ==="
    kubectl get services -n ingress-nginx
    echo ""
    echo "=== INGRESS CLASSES ==="
    kubectl get ingressclasses
    echo ""
    echo "=== EVENTOS RECIENTES ==="
    kubectl get events -n ingress-nginx --sort-by='.lastTimestamp' --tail=20
  register: status_check
  
- debug:
    var: status_check.stdout

- name: ğŸ“¡ Obtener LoadBalancer URL (si estÃ¡ disponible)
  shell: |
    kubectl get service -n ingress-nginx nginx-ingress-ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "PENDIENTE"
  register: lb_url

- name: ğŸŒ Mostrar informaciÃ³n del Ingress
  debug:
    msg: |
      ğŸ“Š ESTADO DEL INGRESS CONTROLLER:
      
      ğŸ“ LoadBalancer URL: {{ lb_url.stdout }}
      ğŸ”§ Helm Install Exit Code: {{ helm_install.rc }}
      â±ï¸ Wait Result Exit Code: {{ wait_result.rc }}
      
      {% if wait_result.rc == 0 %}
      ğŸ‰ INGRESS CONTROLLER INSTALADO EXITOSAMENTE!
      {% elif wait_result.rc == 124 %}
      âš ï¸ INGRESS CONTROLLER PARCIALMENTE INSTALADO (Timeout)
      {% else %}
      âŒ INGRESS CONTROLLER CON PROBLEMAS
      {% endif %}
      
      ğŸ” Comandos de verificaciÃ³n:
      kubectl get pods -n ingress-nginx
      kubectl get service -n ingress-nginx
      kubectl describe pod -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx
      
      ğŸŒ Para acceder a tu aplicaciÃ³n (cuando estÃ© lista):
      curl http://{{ lb_url.stdout }}