---
- name: ğŸ§¹ Limpieza COMPLETA - EKS + Recursos Asociados
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    cluster_name: "cc-contenedores-cluster"
    nodegroup_name: "cc-contenedores-nodes"
    aws_region: "us-east-1"
    project_name: "cc-contenedores"

  tasks:
    - name: ğŸ“Š Estado inicial
      debug:
        msg: "ğŸ”„ INICIANDO LIMPIEZA COMPLETA - EKS + RECURSOS ASOCIADOS"

    - name: ğŸ” Verificar si el cluster existe
      shell: |
        aws eks describe-cluster \
          --name "{{ cluster_name }}" \
          --region "{{ aws_region }}" \
          --query 'cluster.status' \
          --output text 2>/dev/null || echo "NOT_FOUND"
      register: cluster_status_check
      ignore_errors: yes

    - name: ğŸ“‹ Mostrar estado del cluster
      debug:
        msg: "Estado del cluster '{{ cluster_name }}': {{ cluster_status_check.stdout }}"

    - name: ğŸ—‘ï¸ 1. Eliminar Node Group (si el cluster existe)
      shell: |
        aws eks delete-nodegroup \
          --cluster-name "{{ cluster_name }}" \
          --nodegroup-name "{{ nodegroup_name }}" \
          --region "{{ aws_region }}" \
          --no-cli-pager
      register: delete_nodegroup
      ignore_errors: yes
      when: cluster_status_check.stdout != "NOT_FOUND"

    - name: â³ Esperar eliminaciÃ³n Node Group
      shell: |
        echo "â³ Esperando eliminaciÃ³n del node group..."
        for i in {1..60}; do
          STATUS=$(aws eks describe-nodegroup \
            --cluster-name "{{ cluster_name }}" \
            --nodegroup-name "{{ nodegroup_name }}" \
            --region "{{ aws_region }}" \
            --query 'nodegroup.status' \
            --output text 2>/dev/null || echo "DELETED")
          
          echo "Intento $i/60 - Estado: $STATUS"
          
          if [ "$STATUS" = "DELETED" ] || [ "$STATUS" = "NOT_FOUND" ]; then
            echo "âœ… Node group eliminado"
            exit 0
          fi
          sleep 30
        done
        echo "âŒ Timeout eliminaciÃ³n node group"
        exit 1
      register: wait_nodegroup
      async: 2100
      poll: 0
      when: 
        - cluster_status_check.stdout != "NOT_FOUND"
        - delete_nodegroup is defined

    - name: ğŸ—‘ï¸ 2. Eliminar Cluster EKS (si existe)
      shell: |
        aws eks delete-cluster \
          --name "{{ cluster_name }}" \
          --region "{{ aws_region }}" \
          --no-cli-pager
      register: delete_cluster
      ignore_errors: yes
      when: cluster_status_check.stdout != "NOT_FOUND"

    - name: â³ Esperar eliminaciÃ³n Cluster
      shell: |
        echo "â³ Esperando eliminaciÃ³n del cluster..."
        for i in {1..80}; do
          STATUS=$(aws eks describe-cluster \
            --name "{{ cluster_name }}" \
            --region "{{ aws_region }}" \
            --query 'cluster.status' \
            --output text 2>/dev/null || echo "DELETED")
          
          echo "Intento $i/80 - Estado: $STATUS"
          
          if [ "$STATUS" = "DELETED" ] || [ "$STATUS" = "NOT_FOUND" ]; then
            echo "âœ… Cluster eliminado"
            exit 0
          fi
          sleep 30
        done
        echo "âŒ Timeout eliminaciÃ³n cluster"
        exit 1
      register: wait_cluster
      async: 2700
      poll: 0
      when: 
        - cluster_status_check.stdout != "NOT_FOUND"
        - delete_cluster is defined

    - name: ğŸ” 3. Buscar recursos huÃ©rfanos del cluster
      block:
        - name: ğŸ” Buscar Auto Scaling Groups del cluster
          shell: |
            aws autoscaling describe-auto-scaling-groups \
              --region "{{ aws_region }}" \
              --query "AutoScalingGroups[?contains(Tags[?Key=='eks:cluster-name'].Value, '{{ cluster_name }}')].AutoScalingGroupName" \
              --output text 2>/dev/null || echo ""
          register: asg_list

        - name: ğŸ” Buscar Launch Templates del cluster
          shell: |
            aws ec2 describe-launch-templates \
              --region "{{ aws_region }}" \
              --query "LaunchTemplates[?contains(LaunchTemplateName, '{{ cluster_name }}')].LaunchTemplateName" \
              --output text 2>/dev/null || echo ""
          register: lt_list

        - name: ğŸ” Buscar Network Interfaces del cluster
          shell: |
            aws ec2 describe-network-interfaces \
              --region "{{ aws_region }}" \
              --filters "Name=description,Values=*{{ cluster_name }}*" \
              --query 'NetworkInterfaces[].NetworkInterfaceId' \
              --output text 2>/dev/null || echo ""
          register: eni_list

        - name: ğŸ” Buscar Security Groups automÃ¡ticos del cluster
          shell: |
            aws ec2 describe-security-groups \
              --region "{{ aws_region }}" \
              --filters "Name=group-name,Values=*eks*{{ cluster_name }}*" \
              --query 'SecurityGroups[].GroupId' \
              --output text 2>/dev/null || echo ""
          register: sg_auto_list

      always:
        - name: ğŸ“Š Mostrar recursos encontrados
          debug:
            msg: |
              Recursos huÃ©rfanos encontrados:
              - Auto Scaling Groups: {{ asg_list.stdout | default('Ninguno') }}
              - Launch Templates: {{ lt_list.stdout | default('Ninguno') }}
              - Network Interfaces: {{ eni_list.stdout | default('Ninguno') }}
              - Security Groups: {{ sg_auto_list.stdout | default('Ninguno') }}

    - name: ğŸ—‘ï¸ 4. Eliminar recursos huÃ©rfanos
      block:
        - name: ğŸ—‘ï¸ Eliminar Auto Scaling Groups
          shell: |
            aws autoscaling delete-auto-scaling-group \
              --auto-scaling-group-name "{{ item }}" \
              --region "{{ aws_region }}" \
              --force-delete
          loop: "{{ asg_list.stdout.split() }}"
          ignore_errors: yes
          when: asg_list.stdout | length > 0

        - name: ğŸ—‘ï¸ Eliminar Launch Templates
          shell: |
            aws ec2 delete-launch-template \
              --launch-template-name "{{ item }}" \
              --region "{{ aws_region }}"
          loop: "{{ lt_list.stdout.split() }}"
          ignore_errors: yes
          when: lt_list.stdout | length > 0

        - name: ğŸ—‘ï¸ Eliminar Network Interfaces
          shell: |
            aws ec2 delete-network-interface \
              --network-interface-id "{{ item }}" \
              --region "{{ aws_region }}"
          loop: "{{ eni_list.stdout.split() }}"
          ignore_errors: yes
          when: eni_list.stdout | length > 0

        - name: ğŸ—‘ï¸ Eliminar Security Groups automÃ¡ticos
          shell: |
            aws ec2 delete-security-group \
              --group-id "{{ item }}" \
              --region "{{ aws_region }}"
          loop: "{{ sg_auto_list.stdout.split() }}"
          ignore_errors: yes
          when: sg_auto_list.stdout | length > 0

    - name: ğŸ§¹ 5. Limpiar configuraciÃ³n local
      shell: |
        echo "ğŸ§¹ Limpiando configuraciÃ³n local de kubectl..."
        kubectl config delete-cluster "{{ cluster_name }}" 2>/dev/null || echo "âš ï¸ Cluster config no existe"
        kubectl config delete-context "{{ cluster_name }}" 2>/dev/null || echo "âš ï¸ Context no existe"
        kubectl config unset users.{{ cluster_name }} 2>/dev/null || echo "âš ï¸ User config no existe"
        echo "âœ… ConfiguraciÃ³n local limpiada"
      ignore_errors: yes

    - name: ğŸ” 6. VerificaciÃ³n final
      shell: |
        echo "=== VERIFICACIÃ“N FINAL ==="
        echo ""
        echo "ğŸ“‹ Clusters EKS existentes:"
        aws eks list-clusters --region "{{ aws_region }}" --query 'clusters' --output table 2>/dev/null || echo "No hay clusters"
        echo ""
        echo "ğŸ”„ Auto Scaling Groups huÃ©rfanos:"
        aws autoscaling describe-auto-scaling-groups --region "{{ aws_region }}" --query "AutoScalingGroups[?contains(Tags[?Key=='eks:cluster-name'].Value, '{{ cluster_name }}')].AutoScalingGroupName" --output table 2>/dev/null || echo "No hay ASGs huÃ©rfanos"
        echo ""
        echo "ğŸŒ Network Interfaces huÃ©rfanas:"
        aws ec2 describe-network-interfaces --region "{{ aws_region }}" --filters "Name=description,Values=*{{ cluster_name }}*" --query 'NetworkInterfaces[].NetworkInterfaceId' --output table 2>/dev/null || echo "No hay ENIs huÃ©rfanas"
      register: final_check

    - debug:
        var: final_check.stdout

    - name: âœ… Resumen de limpieza
      debug:
        msg: |
          ğŸ‰ PROCESO DE LIMPIEZA COMPLETADO

          ğŸ“Š RESULTADO:
          - Cluster: {{ cluster_name }}
          - Estado inicial: {{ cluster_status_check.stdout }}
          - Node Groups eliminados: {{ 'âœ…' if cluster_status_check.stdout == 'NOT_FOUND' or delete_nodegroup is defined else 'âŒ' }}
          - Cluster eliminado: {{ 'âœ…' if cluster_status_check.stdout == 'NOT_FOUND' or delete_cluster is defined else 'âŒ' }}
          - Recursos huÃ©rfanos limpiados: {{ (asg_list.stdout.split() + lt_list.stdout.split() + eni_list.stdout.split() + sg_auto_list.stdout.split()) | length }}

          ğŸ’¡ Si el cluster ya estaba eliminado, se limpiaron recursos huÃ©rfanos.
          ğŸ’¡ La eliminaciÃ³n fÃ­sica en AWS puede continuar en segundo plano.