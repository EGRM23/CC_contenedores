---
- name: ðŸ§¹ Limpieza Completa - Cluster EKS y Recursos
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    cluster_name: "cc-contenedores-cluster"
    nodegroup_name: "cc-contenedores-nodes"
    aws_region: "us-east-1"
    k8s_namespace: "cc-contenedores"

  tasks:
    - name: ðŸ“Š Estado inicial
      debug:
        msg: "ðŸ”„ INICIANDO LIMPIEZA COMPLETA DEL CLUSTER EKS"

    - name: ðŸ” Verificar que el cluster existe
      shell: |
        aws eks describe-cluster \
          --name "{{ cluster_name }}" \
          --region "{{ aws_region }}" \
          --query 'cluster.status' \
          --output text 2>/dev/null || echo "NOT_FOUND"
      register: cluster_status
      ignore_errors: yes

    - name: ðŸ“‹ Mostrar estado del cluster
      debug:
        msg: "Estado del cluster '{{ cluster_name }}': {{ cluster_status.stdout }}"

    - name: ðŸ” Verificar node groups existentes
      shell: |
        aws eks list-nodegroups \
          --cluster-name "{{ cluster_name }}" \
          --region "{{ aws_region }}" \
          --query 'nodegroups' \
          --output table 2>/dev/null || echo "NO_NODEGROUPS"
      register: existing_nodegroups
      ignore_errors: yes

    - debug:
        var: existing_nodegroups.stdout

    - name: ðŸ—‘ï¸ Eliminar node group (si existe)
      shell: |
        aws eks delete-nodegroup \
          --cluster-name "{{ cluster_name }}" \
          --nodegroup-name "{{ nodegroup_name }}" \
          --region "{{ aws_region }}" \
          --no-cli-pager
      register: delete_nodegroup
      ignore_errors: yes
      when: cluster_status.stdout != "NOT_FOUND"

    - name: â³ Esperar eliminaciÃ³n del node group (con timeout)
      shell: |
        echo "â³ Esperando eliminaciÃ³n del node group (mÃ¡ximo 30 minutos)..."
        TIMEOUT=1800  # 30 minutos
        START_TIME=$(date +%s)
        
        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))
          
          if [ $ELAPSED -gt $TIMEOUT ]; then
            echo "âŒ TIMEOUT: Node group no se eliminÃ³ en 30 minutos"
            exit 1
          fi
          
          STATUS=$(aws eks describe-nodegroup \
            --cluster-name "{{ cluster_name }}" \
            --nodegroup-name "{{ nodegroup_name }}" \
            --region "{{ aws_region }}" \
            --query 'nodegroup.status' \
            --output text 2>/dev/null || echo "DELETED")
          
          echo "Estado node group: $STATUS - Tiempo transcurrido: ${ELAPSED}s"
          
          if [ "$STATUS" = "DELETED" ] || [ "$STATUS" = "NOT_FOUND" ]; then
            echo "âœ… Node group eliminado exitosamente"
            exit 0
          fi
          sleep 30
        done
      register: wait_nodegroup
      async: 2100  # 35 minutos (un poco mÃ¡s del timeout)
      poll: 0
      when: 
        - cluster_status.stdout != "NOT_FOUND"
        - delete_nodegroup is defined
        - delete_nodegroup.rc == 0

    - name: ðŸ“Š Verificar resultado eliminaciÃ³n node group
      debug:
        msg: |
          Resultado eliminaciÃ³n node group:
          - Comando eliminaciÃ³n: {{ delete_nodegroup.rc | default('NO_EJECUTADO') }}
          - Monitoreo: {{ wait_nodegroup.rc | default('NO_INICIADO') }}
      when: cluster_status.stdout != "NOT_FOUND"

    - name: ðŸ—‘ï¸ Eliminar cluster EKS (si existe)
      shell: |
        aws eks delete-cluster \
          --name "{{ cluster_name }}" \
          --region "{{ aws_region }}" \
          --no-cli-pager
      register: delete_cluster
      ignore_errors: yes
      when: cluster_status.stdout != "NOT_FOUND"

    - name: â³ Esperar eliminaciÃ³n del cluster (con timeout)
      shell: |
        echo "â³ Esperando eliminaciÃ³n del cluster (mÃ¡ximo 40 minutos)..."
        TIMEOUT=2400  # 40 minutos
        START_TIME=$(date +%s)
        
        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))
          
          if [ $ELAPSED -gt $TIMEOUT ]; then
            echo "âŒ TIMEOUT: Cluster no se eliminÃ³ en 40 minutos"
            exit 1
          fi
          
          STATUS=$(aws eks describe-cluster \
            --name "{{ cluster_name }}" \
            --region "{{ aws_region }}" \
            --query 'cluster.status' \
            --output text 2>/dev/null || echo "DELETED")
          
          echo "Estado cluster: $STATUS - Tiempo transcurrido: ${ELAPSED}s"
          
          if [ "$STATUS" = "DELETED" ] || [ "$STATUS" = "NOT_FOUND" ]; then
            echo "âœ… Cluster eliminado exitosamente"
            exit 0
          fi
          sleep 30
        done
      register: wait_cluster
      async: 2700  # 45 minutos (un poco mÃ¡s del timeout)
      poll: 0
      when: 
        - cluster_status.stdout != "NOT_FOUND"
        - delete_cluster is defined
        - delete_cluster.rc == 0

    - name: ðŸ“Š Verificar resultado eliminaciÃ³n cluster
      debug:
        msg: |
          Resultado eliminaciÃ³n cluster:
          - Comando eliminaciÃ³n: {{ delete_cluster.rc | default('NO_EJECUTADO') }}
          - Monitoreo: {{ wait_cluster.rc | default('NO_INICIADO') }}
      when: cluster_status.stdout != "NOT_FOUND"

    - name: ðŸ§¹ Limpiar recursos Kubernetes locales
      shell: |
        echo "ðŸ§¹ Limpiando configuraciÃ³n local de kubectl..."
        kubectl config delete-cluster "{{ cluster_name }}" 2>/dev/null || echo "âš ï¸ Cluster config no existe"
        kubectl config delete-context "{{ cluster_name }}" 2>/dev/null || echo "âš ï¸ Context no existe"
        kubectl config unset users.{{ cluster_name }} 2>/dev/null || echo "âš ï¸ User config no existe"
        echo "âœ… ConfiguraciÃ³n local de kubectl limpiada"
      ignore_errors: yes

    - name: ðŸ” VerificaciÃ³n final
      shell: |
        echo "=== VERIFICACIÃ“N FINAL ==="
        echo "Clusters EKS existentes:"
        aws eks list-clusters --region "{{ aws_region }}" --query 'clusters' --output table 2>/dev/null || echo "No hay clusters"
        echo ""
        echo "Node Groups en '{{ cluster_name }}':"
        aws eks list-nodegroups --cluster-name "{{ cluster_name }}" --region "{{ aws_region }}" --query 'nodegroups' --output table 2>/dev/null || echo "No hay node groups"
      register: final_check

    - debug:
        var: final_check.stdout

    - name: âœ… Resumen de limpieza
      debug:
        msg: |
          ðŸŽ‰ PROCESO DE LIMPIEZA COMPLETADO
          
          ðŸ“Š RESULTADO:
          - Cluster: {{ cluster_name }}
          - Estado inicial: {{ cluster_status.stdout }}
          - EliminaciÃ³n node group: {{ delete_nodegroup.rc | default('NO_EJECUTADO') }}
          - EliminaciÃ³n cluster: {{ delete_cluster.rc | default('NO_EJECUTADO') }}
          
          ðŸ’¡ Nota: La eliminaciÃ³n fÃ­sica puede continuar en segundo plano en AWS.
          ðŸ’¡ Verifica en la consola AWS en unos minutos.