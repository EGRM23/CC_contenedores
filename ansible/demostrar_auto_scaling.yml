---
- name: ğŸ§ª Demostrar Auto Scaling AutomÃ¡tico
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    project_name: "cc-contenedores"
    aws_region: "us-east-1"

  tasks:
    - name: ğŸ“Š Estado INICIAL del Auto Scaling
      amazon.aws.autoscaling_group_info:
        name: "{{ project_name }}-asg"
        region: "{{ aws_region }}"  
      register: estado_inicial

    - name: ğŸ–¨ï¸ Mostrar estado inicial
      debug:
        msg: |
          ğŸ¯ ESTADO INICIAL DEL AUTO SCALING:
          - Instancias: {{ estado_inicial.results[0].instances | length }}
          - Desired Capacity: {{ estado_inicial.results[0].desired_capacity }}
          - MÃ¡ximo: {{ estado_inicial.results[0].max_size }}
          {% for instance in estado_inicial.results[0].instances %}
          - {{ instance.instance_id }} ({{ instance.lifecycle_state }})
          {% endfor %}

    - name: ğŸ¯ Verificar que hay capacidad para escalar
      debug:
        msg: |
          ğŸ“ˆ CAPACIDAD DE ESCALADO:
          - Instancias actuales: {{ estado_inicial.results[0].instances | length }}
          - LÃ­mite mÃ¡ximo: {{ estado_inicial.results[0].max_size }}
          - Puede crear hasta {{ estado_inicial.results[0].max_size - estado_inicial.results[0].instances | length }} instancias mÃ¡s
      when: estado_inicial.results[0].instances | length < estado_inicial.results[0].max_size

    - name: ğŸ¯ Obtener una instancia EXISTENTE del ASG para generar carga
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        filters:
          "tag:aws:autoscaling:groupName": "{{ project_name }}-asg"
          "instance-state-name": "running"
      register: instancias_asg

    - name: ğŸš€ Generar carga de CPU en instancia EXISTENTE del ASG
      block:
        - name: ğŸ” Verificar que tenemos instancias del ASG
          debug:
            msg: |
              ğŸ“¡ INSTANCIA SELECCIONADA PARA CARGA:
              - ID: {{ instancias_asg.instances[0].instance_id }}
              - IP: {{ instancias_asg.instances[0].public_ip_address }}
              - Estado: {{ instancias_asg.instances[0].state.name }}

        - name: ğŸ”§ Instalar y ejecutar stress-ng via SSH en instancia existente
          ansible.builtin.shell: |
            ssh -o StrictHostKeyChecking=no -i ~/.ssh/mi-keypair.pem ec2-user@{{ instancias_asg.instances[0].public_ip_address }} '
            echo "ğŸ¯ INICIANDO PRUEBA DE CARGA DE CPU..."
            sudo yum update -y && sudo yum install -y stress-ng
            echo "ğŸ”¥ Generando 80% de carga de CPU por 8 minutos..."
            nohup sudo stress-ng --cpu 2 --timeout 480 > /tmp/stress.log 2>&1 &
            echo "âœ… Carga de CPU iniciada - Auto Scaling deberÃ­a activarse"
            echo "ğŸ“Š Procesos stress-ng activos:"
            ps aux | grep stress-ng | grep -v grep
            '
          args:
            executable: /bin/bash
          register: resultado_stress
          async: 180
          poll: 0

        - name: ğŸ“ Confirmar inicio de carga
          debug:
            msg: |
              ğŸš€ CARGA DE CPU INICIADA EN INSTANCIA EXISTENTE:
              - Instancia: {{ instancias_asg.instances[0].instance_id }}
              - IP: {{ instancias_asg.instances[0].public_ip_address }}
              - DuraciÃ³n: 8 minutos
              - Comando ejecutado asÃ­ncronamente
        
        - name: ğŸ“Š Verificar carga de CPU despuÃ©s de 30 segundos
          ansible.builtin.shell: |
            ssh -o StrictHostKeyChecking=no -i ~/.ssh/mi-keypair.pem ec2-user@{{ instancias_asg.instances[0].public_ip_address }} '
            echo "ğŸ“ˆ MÃ‰TRICAS DE CPU A LOS 30 SEGUNDOS:"
            mpstat 1 3
            echo "ğŸ” PROCESOS STRESS-NG ACTIVOS:"
            ps aux | grep stress-ng | grep -v grep
            echo "ğŸ“Š CARGA DEL SISTEMA:"
            uptime
            '
          args:
            executable: /bin/bash
          register: metricas_cpu
          delay: 30

        - name: ğŸ–¨ï¸ Mostrar mÃ©tricas de CPU iniciales
          debug:
            msg: "{{ metricas_cpu.stdout }}"
      
      when: instancias_asg.instances | length > 0

    - name: â³ Esperar a que CloudWatch detecte la mÃ©trica (2-3 minutos)
      pause:
        minutes: 3
        prompt: "â° Esperando a que CloudWatch detecte la carga alta de CPU (puede tomar 2-3 minutos para las mÃ©tricas...)"

    - name: ğŸ“ InformaciÃ³n de la instancia de carga
      debug:
        msg: |
          ğŸ”¥ CARGA EJECUTÃNDOSE EN INSTANCIA EXISTENTE:
          - ID: {{ instancias_asg.instances[0].instance_id }}
          - IP: {{ instancias_asg.instances[0].public_ip_address }}
          - Tiempo restante de carga: ~5 minutos
          - MÃ©trica objetivo: CPU > 50% por 2 minutos consecutivos

    - name: ğŸ“ˆ Monitorear actividades de escalado
      amazon.aws.autoscaling_group_info:
        name: "{{ project_name }}-asg"
        region: "{{ aws_region }}"
      register: estado_intermedio
      until: estado_intermedio.results[0].instances | length > estado_inicial.results[0].instances | length
      retries: 10
      delay: 30

    - name: ğŸ‰ Mostrar resultado del escalado
      debug:
        msg: |
          {% set instancias_inicial = estado_inicial.results[0].instances | length %}
          {% set instancias_actual = estado_intermedio.results[0].instances | length %}
          {% if instancias_actual > instancias_inicial %}
          âœ… Â¡AUTO SCALING AUTOMÃTICO FUNCIONANDO!
          
          ğŸ¯ RESULTADO:
          - Instancias INICIALES: {{ instancias_inicial }}
          - Instancias ACTUALES: {{ instancias_actual }}
          - Â¡Se crearon {{ instancias_actual - instancias_inicial }} instancias AUTOMÃTICAMENTE!
          
          ğŸ“ˆ MÃ©trica activadora: CPU > 50% por 2 minutos
          ğŸ”¥ Causa: Carga de CPU generada por stress-ng
          âš¡ Respuesta: Auto Scaling detectÃ³ y creÃ³ nueva instancia
          
          {% else %}
          âš ï¸  El Auto Scaling no activÃ³ automÃ¡ticamente despuÃ©s de 5 minutos
          - Instancias iniciales: {{ instancias_inicial }}
          - Instancias actuales: {{ instancias_actual }}
          - Posibles causas:
            * Las mÃ©tricas de CloudWatch pueden tardar mÃ¡s
            * El umbral de CPU (50%) no se alcanzÃ³
            * Verificar configuraciÃ³n de alarmas
          {% endif %}

    - name: ğŸ“‹ Comandos para verificar manualmente
      debug:
        msg: |
          ğŸ” PARA VERIFICAR MANUALMENTE:
          
          Ver estado actual:
          aws autoscaling describe-auto-scaling-groups --auto-scaling-group-name {{ project_name }}-asg --region {{ aws_region }}
          
          Ver actividades recientes:
          aws autoscaling describe-scaling-activities --auto-scaling-group-name {{ project_name }}-asg --region {{ aws_region }} --max-items 5
          
          Ver alarmas de CloudWatch:
          aws cloudwatch describe-alarms --alarm-name-prefix "high-cpu-{{ project_name }}" --region {{ aws_region }}