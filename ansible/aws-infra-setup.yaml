---
- name: ğŸ—ï¸ Gestionar VPC existente o crear nueva
  block:
    - name: Buscar VPC existente
      amazon.aws.ec2_vpc_net_info:
        region: "{{ aws_region }}"
        filters:
          "tag:Project": "{{ project_name }}"
      register: vpc_existente

    - name: Crear nueva VPC si no existe
      amazon.aws.ec2_vpc_net:
        name: "{{ project_name }}-vpc"
        cidr_block: "{{ vpc_cidr }}"
        region: "{{ aws_region }}"
        tags:
          Project: "{{ project_name }}"
      register: nueva_vpc
      when: vpc_existente.vpcs | length == 0

    - name: Configurar VPC ID
      set_fact:
        vpc_id: "{{ (vpc_existente.vpcs[0].vpc_id if vpc_existente.vpcs else nueva_vpc.vpc.id) }}"
        vpc_accion: "{{ 'reutilizada' if vpc_existente.vpcs else 'creada' }}"

  rescue:
    - name: ğŸš¨ Crear VPC de emergencia
      amazon.aws.ec2_vpc_net:
        name: "{{ project_name }}-vpc-emergencia"
        cidr_block: "10.99.0.0/16"
        region: "{{ aws_region }}"
        tags:
          Project: "{{ project_name }}"
      register: vpc_emergencia
      
    - name: Configurar VPC de emergencia
      set_fact:
        vpc_id: "{{ vpc_emergencia.vpc.id }}"
        vpc_accion: "emergencia"

- name: ğŸŒ Gestionar Internet Gateway
  block:
    - name: Verificar si la VPC ya tiene Internet Gateway
      amazon.aws.ec2_vpc_igw_info:
        region: "{{ aws_region }}"
        filters:
          "attachment.vpc-id": "{{ vpc_id }}"
      register: igw_existente

    - name: Crear Internet Gateway si no existe
      amazon.aws.ec2_vpc_igw:
        vpc_id: "{{ vpc_id }}"
        region: "{{ aws_region }}"
        tags:
          Project: "{{ project_name }}"
      when: igw_existente.internet_gateways | length == 0

  rescue:
    - debug:
        msg: "Internet Gateway podrÃ­a ya estar configurado"

- name: ğŸ”— Gestionar MÃšLTIPLES Subnets para EKS
  block:
    - name: Buscar Subnets existentes en la VPC
      amazon.aws.ec2_vpc_subnet_info:
        region: "{{ aws_region }}"
        filters:
          vpc-id: "{{ vpc_id }}"
          "tag:Project": "{{ project_name }}"
      register: subnets_existentes

    - name: ğŸ†• Crear Subnet 1 en {{ availability_zone_1 }}
      amazon.aws.ec2_vpc_subnet:
        vpc_id: "{{ vpc_id }}"
        cidr: "{{ subnet_1_cidr }}"
        region: "{{ aws_region }}"
        az: "{{ availability_zone_1 }}"
        map_public: true
        tags:
          Name: "{{ project_name }}-subnet-1a"
          Project: "{{ project_name }}"
          AZ: "{{ availability_zone_1 }}"
      register: subnet_1a
      when: subnets_existentes.subnets | selectattr('availability_zone', 'equalto', availability_zone_1) | list | length == 0

    - name: ğŸ†• Crear Subnet 2 en {{ availability_zone_2 }}
      amazon.aws.ec2_vpc_subnet:
        vpc_id: "{{ vpc_id }}"
        cidr: "{{ subnet_2_cidr }}"
        region: "{{ aws_region }}"
        az: "{{ availability_zone_2 }}"
        map_public: true
        tags:
          Name: "{{ project_name }}-subnet-1b"
          Project: "{{ project_name }}"
          AZ: "{{ availability_zone_2 }}"
      register: subnet_1b
      when: subnets_existentes.subnets | selectattr('availability_zone', 'equalto', availability_zone_2) | list | length == 0

    - name: ğŸ“‹ Obtener IDs de subnets (usar existentes o nuevas)
      set_fact:
        subnet_ids: |
          {%- set subs = [] -%}
          {%- for subnet in subnets_existentes.subnets -%}
            {%- if subs | length < 2 -%}
              {%- set _ = subs.append(subnet.id) -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if subs | length < 2 and subnet_1a is defined and subnet_1a.changed -%}
            {%- set _ = subs.append(subnet_1a.subnet.id) -%}
          {%- endif -%}
          {%- if subs | length < 2 and subnet_1b is defined and subnet_1b.changed -%}
            {%- set _ = subs.append(subnet_1b.subnet.id) -%}
          {%- endif -%}
          {{ subs }}
    
    # - name: ğŸŒ Habilitar IP pÃºblica automÃ¡tica en Subnet 1
    #   amazon.aws.ec2_vpc_subnet:
    #     subnet_id: "{{ subnet_ids[0] }}"
    #     region: "{{ aws_region }}"
    #     map_public: true
    #   when: subnet_ids | length > 0

    # - name: ğŸŒ Habilitar IP pÃºblica automÃ¡tica en Subnet 2
    #   amazon.aws.ec2_vpc_subnet:
    #     subnet_id: "{{ subnet_ids[1] }}"
    #     region: "{{ aws_region }}"
    #     map_public: true
    #   when: subnet_ids | length > 1

    - name: ğŸŒ Habilitar IP pÃºblica automÃ¡tica en Subnet 1
      shell: |
        aws ec2 modify-subnet-attribute \
          --subnet-id "{{ subnet_ids[0] }}" \
          --map-public-ip-on-launch \
          --region "{{ aws_region }}"
      when: subnet_ids | length > 0

    - name: ğŸŒ Habilitar IP pÃºblica automÃ¡tica en Subnet 2
      shell: |
        aws ec2 modify-subnet-attribute \
          --subnet-id "{{ subnet_ids[1] }}" \
          --map-public-ip-on-launch \
          --region "{{ aws_region }}"
      when: subnet_ids | length > 1

    - name: ğŸ” Verificar que tenemos al menos 2 subnets
      fail:
        msg: "Se necesitan al menos 2 subnets en diferentes AZs para EKS. Solo se encontraron/crearon {{ subnet_ids | length }}"
      when: subnet_ids | length < 2
    
    - name: ğŸ” Verificar IP pÃºblica habilitada
      shell: |
        aws ec2 describe-subnets \
          --subnet-ids "{{ item }}" \
          --region "{{ aws_region }}" \
          --query 'Subnets[0].MapPublicIpOnLaunch'
      loop: "{{ subnet_ids }}"
      register: subnet_public_ip_check
      loop_control:
        label: "{{ item }}"

    - debug:
        msg: "Subnet {{ item.item }} - MapPublicIpOnLaunch: {{ item.stdout }}"
      loop: "{{ subnet_public_ip_check.results }}"

- name: ğŸ›¡ï¸ Crear o actualizar Security Group
  block:
    - name: Buscar Security Group existente
      amazon.aws.ec2_security_group_info:
        region: "{{ aws_region }}"
        filters:
          group-name: "{{ project_name }}-sg"
          vpc-id: "{{ vpc_id }}"
      register: sg_existente

    - name: ğŸ†• Crear Security Group con todas las reglas (si no existe)
      amazon.aws.ec2_security_group:
        name: "{{ project_name }}-sg"
        description: "Security group para EKS cluster"
        vpc_id: "{{ vpc_id }}"
        region: "{{ aws_region }}"
        rules:
          - proto: tcp
            from_port: 80
            to_port: 80
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 443
            to_port: 443
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 22
            to_port: 22
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 3000
            to_port: 3000
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 6443
            to_port: 6443
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 1025
            to_port: 65535
            cidr_ip: "0.0.0.0/0"
        tags:
          Project: "{{ project_name }}"
      register: sg_nuevo
      when: sg_existente.security_groups | length == 0
    
    - name: ğŸ”„ Agregar reglas al Security Group existente (si ya existe)
      amazon.aws.ec2_security_group:
        group_id: "{{ sg_existente.security_groups[0].group_id }}"
        name: "{{ project_name }}-sg"
        description: "Security group para EKS cluster"
        region: "{{ aws_region }}"
        rules:
          - proto: tcp
            from_port: 80
            to_port: 80
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 443
            to_port: 443
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 22
            to_port: 22
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 3000
            to_port: 3000
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 6443
            to_port: 6443
            cidr_ip: 0.0.0.0/0
          - proto: tcp
            from_port: 1025
            to_port: 65535
            cidr_ip: "0.0.0.0/0"
        purge_rules: false
      when: sg_existente.security_groups | length > 0

    - name: Configurar Security Group ID
      set_fact:
        security_group_id: "{{ (sg_existente.security_groups[0].group_id if sg_existente.security_groups else sg_nuevo.group_id) }}"
        security_group_action: "{{ 'reutilizado' if sg_existente.security_groups else 'creado' }}"

- name: ğŸ“ Estado de infraestructura base
  debug:
    msg: |
      âœ… INFRAESTRUCTURA BASE CONFIGURADA:
      - VPC: {{ vpc_id }} ({{ vpc_accion }})
      - Subnets: {{ subnet_ids | join(', ') }} (Total: {{ subnet_ids | length }})
      - Security Group: {{ security_group_id }} ({{ security_group_action }})