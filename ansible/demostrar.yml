---
- name: ğŸ§ª Demostrar Auto Scaling AutomÃ¡tico (SIN SSM)
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    project_name: "cc-contenedores"
    aws_region: "us-east-1"

  tasks:
    - name: ğŸ“Š Estado INICIAL del Auto Scaling
      amazon.aws.autoscaling_group_info:
        name: "{{ project_name }}-asg"
        region: "{{ aws_region }}"
      register: estado_inicial

    - name: ğŸ–¨ï¸ Mostrar estado inicial
      debug:
        msg: |
          ğŸ¯ ESTADO INICIAL DEL AUTO SCALING:
          - Instancias: {{ estado_inicial.auto_scaling_groups[0].instances | length }}
          - Desired Capacity: {{ estado_inicial.auto_scaling_groups[0].desired_capacity }}
          - MÃ¡ximo: {{ estado_inicial.auto_scaling_groups[0].max_size }}
          {% for instance in estado_inicial.auto_scaling_groups[0].instances %}
          - {{ instance.instance_id }} ({{ instance.lifecycle_state }})
          {% endfor %}

    - name: ğŸ¯ Verificar capacidad de escalado
      debug:
        msg: |
          ğŸ“ˆ CAPACIDAD DE ESCALADO:
          - Puede crear hasta {{ estado_inicial.auto_scaling_groups[0].max_size - estado_inicial.auto_scaling_groups[0].instances | length }} instancias mÃ¡s
      when: estado_inicial.auto_scaling_groups[0].instances | length < estado_inicial.auto_scaling_groups[0].max_size

    - name: ğŸ”¥ SIMULAR carga alta de CPU activando alarma manualmente
      block:
        - name: Activar alarma de CPU alta
          shell: |
            aws cloudwatch set-alarm-state \
              --alarm-name "high-cpu-{{ project_name }}-asg" \
              --state-value ALARM \
              --state-reason "Test auto scaling demonstration" \
              --region "{{ aws_region }}"
          register: activate_alarm

        - debug:
            msg: "âœ… Alarma de CPU alta activada manualmente"

      rescue:
        - name: âš ï¸  Fallback Aumentar desired capacity manualmente
          debug:
            msg: "No se pudo activar la alarma, aumentando desired capacity..."

        - name: Aumentar desired capacity para forzar escalado
          amazon.aws.autoscaling_group:
            name: "{{ project_name }}-asg"
            region: "{{ aws_region }}"
            desired_capacity: "{{ estado_inicial.auto_scaling_groups[0].desired_capacity + 1 }}"
            wait_for_instances: false

    - name: â³ Esperar respuesta del Auto Scaling (3 minutos)
      pause:
        minutes: 3
        prompt: "â° Esperando que Auto Scaling reaccione a la alarma de CPU alta..."

    - name: ğŸ“ˆ Monitorear actividades de escalado
      shell: |
        aws autoscaling describe-scaling-activities \
          --auto-scaling-group-name "{{ project_name }}-asg" \
          --region "{{ aws_region }}" \
          --max-items 5 \
          --query 'Activities[].{Time:StartTime, Description:Description, Status:StatusCode}' \
          --output table
      register: actividades
      until: "'InProgress' in actividades.stdout or 'Successful' in actividades.stdout or actividades.rc != 0"
      retries: 6
      delay: 30

    - name: ğŸ‰ Mostrar actividades de escalado
      debug:
        msg: |
          ğŸ“ˆ ACTIVIDADES DE ESCALADO DETECTADAS:
          {{ actividades.stdout }}

    - name: â³ Esperar completaciÃ³n
      pause:
        minutes: 2
        prompt: "ğŸ”„ Esperando que se complete la creaciÃ³n de nueva instancia..."

    - name: ğŸ“Š Estado FINAL del Auto Scaling
      amazon.aws.autoscaling_group_info:
        name: "{{ project_name }}-asg"
        region: "{{ aws_region }}"
      register: estado_final

    - name: ğŸ† Resultado de la demostraciÃ³n
      debug:
        msg: |
          {% set instancias_inicial = estado_inicial.auto_scaling_groups[0].instances | length %}
          {% set instancias_final = estado_final.auto_scaling_groups[0].instances | length %}
          {% if instancias_final > instancias_inicial %}
          âœ… Â¡AUTO SCALING AUTOMÃTICO FUNCIONANDO!
          
          ğŸ¯ RESULTADO:
          - Instancias INICIALES: {{ instancias_inicial }}
          - Instancias FINALES: {{ instancias_final }}
          - Â¡Se crearon {{ instancias_final - instancias_inicial }} instancias AUTOMÃTICAMENTE!
          
          ğŸ“ˆ MÃ©trica activadora: Alarma de CPU alta activada
          âš¡ Respuesta: Auto Scaling detectÃ³ y creÃ³ nueva instancia
          
          {% else %}
          âš ï¸  El Auto Scaling no se activÃ³
          - Instancias INICIALES: {{ instancias_inicial }}
          - Instancias FINALES: {{ instancias_final }}
          
          ğŸ” DiagnÃ³stico:
            aws autoscaling describe-scaling-activities --auto-scaling-group-name {{ project_name }}-asg --region {{ aws_region }} --max-items 10
          {% endif %}

    - name: ğŸ“‹ Comandos para verificar
      debug:
        msg: |
          ğŸ” PARA VERIFICAR MANUALMENTE:
          
          Ver estado: 
          aws autoscaling describe-auto-scaling-groups --auto-scaling-group-name {{ project_name }}-asg --region {{ aws_region }}
          
          Ver actividades:
          aws autoscaling describe-scaling-activities --auto-scaling-group-name {{ project_name }}-asg --region {{ aws_region }} --max-items 10
          
          Ver alarmas:
          aws cloudwatch describe-alarms --alarm-name-prefix "high-cpu-{{ project_name }}" --region {{ aws_region }}