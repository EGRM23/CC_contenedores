---
- name: ðŸ”„ Actualizar Launch Template via AWS CLI (CORREGIDO)
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    project_name: "cc-contenedores"
    aws_region: "us-east-1"

  tasks:
    - name: ðŸ“‹ Crear nueva versiÃ³n del Launch Template con IAM Profile
      shell: |
        aws ec2 create-launch-template-version \
          --launch-template-name "{{ project_name }}-template" \
          --region "{{ aws_region }}" \
          --source-version '$Latest' \
          --version-description "With IAM Profile for SSM" \
          --launch-template-data '{
            "IamInstanceProfile": {
              "Name": "cc-contenedores-ssm-profile"
            }
          }'
      register: create_version

    - debug:
        var: create_version.stdout

    - name: ðŸ”„ Establecer como versiÃ³n por defecto
      shell: |
        aws ec2 modify-launch-template \
          --launch-template-name "{{ project_name }}-template" \
          --region "{{ aws_region }}" \
          --default-version "$(aws ec2 describe-launch-template-versions --launch-template-name {{ project_name }}-template --region {{ aws_region }} --query 'LaunchTemplateVersions[0].VersionNumber' --output text)"
      register: set_default

    - debug:
        var: set_default.stdout

    - name: âœ… Verificar actualizaciÃ³n
      shell: |
        echo "=== Launch Template Data ==="
        aws ec2 describe-launch-template-versions \
          --launch-template-name "{{ project_name }}-template" \
          --region "{{ aws_region }}" \
          --versions '$Default' \
          --query 'LaunchTemplateVersions[0].LaunchTemplateData.IamInstanceProfile' \
          --output table
        
        echo "=== Versiones disponibles ==="
        aws ec2 describe-launch-template-versions \
          --launch-template-name "{{ project_name }}-template" \
          --region "{{ aws_region }}" \
          --query 'LaunchTemplateVersions[].[VersionNumber, VersionDescription]' \
          --output table
      register: verify_lt

    - debug:
        var: verify_lt.stdout
