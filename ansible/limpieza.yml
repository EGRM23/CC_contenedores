---
- name: ğŸ§¹ Limpieza Completa - Eliminar todo incluyendo instancias de prueba
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    project_name: "cc-contenedores"
    aws_region: "us-east-1"

  tasks:
    - name: ğŸ“Š Estado actual
      debug:
        msg: "ğŸ”„ LIMPIEZA COMPLETA - Eliminando TODO incluyendo instancias de prueba"

    - name: ğŸ” Buscar TODAS las instancias del proyecto (running, stopped, terminated)
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        filters:
          "tag:Project": "{{ project_name }}"
      register: todas_instancias

    - name: ğŸ“‹ Mostrar TODAS las instancias encontradas
      debug:
        msg: |
          ğŸ—‘ï¸  TODAS LAS INSTANCIAS ENCONTRADAS:
          {% for instance in todas_instancias.instances %}
          - {{ instance.instance_id }} ({{ instance.state.name }}) - {{ instance.tags.Name | default('Sin nombre') }}
          {% endfor %}
          Total: {{ todas_instancias.instances | length }}

    - name: ğŸ” Buscar instancias de despliegues anteriores (por nombre o tags antiguos)
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        filters:
          "tag:Name": "{{ project_name }}-instance"
          "tag:Environment": "{{ project_name }}"
          "tag:app": "{{ project_name }}"
        include_deprecated: true
      register: instancias_anteriores

    - name: ğŸ“‹ Mostrar instancias de despliegues anteriores encontradas
      debug:
        msg: |
          ğŸ—‘ï¸  INSTANCIAS DE DESPLIEGUES ANTERIORES:
          {% for instance in instancias_anteriores.instances %}
          - {{ instance.instance_id }} ({{ instance.state.name }}) - Tags: {{ instance.tags | default({}) }}
          {% endfor %}
          Total: {{ instancias_anteriores.instances | length }}

    - name: ğŸš« TERMINAR instancias de despliegues anteriores
      amazon.aws.ec2_instance:
        instance_ids: "{{ item.instance_id }}"
        region: "{{ aws_region }}"
        state: absent
        wait: yes
      loop: "{{ instancias_anteriores.instances }}"
      when: 
        - instancias_anteriores.instances | length > 0
        - item.state.name in ['running', 'stopped', 'stopping']
      loop_control:
        label: "{{ item.instance_id }}"

    - name: ğŸš« TERMINAR instancias running/stopped (forzar eliminaciÃ³n)
      amazon.aws.ec2_instance:
        instance_ids: "{{ item.instance_id }}"
        region: "{{ aws_region }}"
        state: absent
        wait: yes
      loop: "{{ todas_instancias.instances }}"
      when: item.state.name in ['running', 'stopped', 'stopping']
      loop_control:
        label: "{{ item.instance_id }}"

    - name: ğŸ—‘ï¸ Eliminar Security Group antiguo (si existe y no tiene dependencias)
      block:
        - name: ğŸ” Buscar Security Group por nombre
          amazon.aws.ec2_security_group_info:
            region: "{{ aws_region }}"
            filters:
              group-name: "{{ project_name }}-sg"
          register: sg_info

        - name: ğŸš« Eliminar Security Group encontrado
          amazon.aws.ec2_security_group:
            region: "{{ aws_region }}"
            name: "{{ project_name }}-sg"
            state: absent
          when: sg_info.security_groups | length > 0
          ignore_errors: yes
          register: sg_delete_result

        - name: ğŸ“‹ Mostrar resultado de eliminaciÃ³n de Security Group
          debug:
            msg: |
              {% if sg_info.security_groups | length > 0 %}
                {% if sg_delete_result.failed %}
                  âš ï¸  No se pudo eliminar el Security Group '{{ project_name }}-sg'. Puede tener dependencias.
                  Error: {{ sg_delete_result.msg }}
                {% else %}
                  âœ… Security Group '{{ project_name }}-sg' eliminado exitosamente
                {% endif %}
              {% else %}
                  â„¹ï¸  Security Group '{{ project_name }}-sg' no encontrado, nada que eliminar
              {% endif %}
      rescue:
        - name: âš ï¸  Error al eliminar Security Group
          debug:
            msg: "âš ï¸  No se pudo eliminar el Security Group '{{ project_name }}-sg'. Puede estar en uso por otros recursos."


    - name: ğŸ—‘ï¸ 1. Eliminar Auto Scaling Group (forzar)
      shell: |
        aws autoscaling delete-auto-scaling-group \
          --auto-scaling-group-name "{{ project_name }}-asg" \
          --force-delete \
          --region "{{ aws_region }}" 2>/dev/null || echo "ASG no existe o ya fue eliminado"
      register: asg_cleanup

    - debug:
        var: asg_cleanup.stdout

    - name: ğŸ—‘ï¸ 2. Eliminar Launch Template  
      shell: |
        aws ec2 delete-launch-template \
          --launch-template-name "{{ project_name }}-template" \
          --region "{{ aws_region }}" 2>/dev/null || echo "Launch Template no existe o ya fue eliminado"
      register: lt_cleanup

    - debug:
        var: lt_cleanup.stdout

    - name: ğŸ—‘ï¸ 3. Eliminar polÃ­ticas de escalado
      shell: |
        # Eliminar polÃ­ticas de escalado si existen
        aws autoscaling describe-policies \
          --auto-scaling-group-name "{{ project_name }}-asg" \
          --region "{{ aws_region }}" \
          --query 'ScalingPolicies[].PolicyName' \
          --output text 2>/dev/null | \
        xargs -r -I {} aws autoscaling delete-policy \
          --policy-name {} \
          --auto-scaling-group-name "{{ project_name }}-asg" \
          --region "{{ aws_region }}" 2>/dev/null || echo "No hay polÃ­ticas que eliminar"
      register: policies_cleanup

    - name: ğŸ—‘ï¸ 4. Eliminar alarmas de CloudWatch
      shell: |
        # Eliminar TODAS las alarmas relacionadas con el proyecto
        aws cloudwatch describe-alarms \
          --alarm-name-prefix "{{ project_name }}" \
          --region "{{ aws_region }}" \
          --query 'MetricAlarms[].AlarmName' \
          --output text 2>/dev/null | \
        xargs -r aws cloudwatch delete-alarms \
          --alarm-names \
          --region "{{ aws_region }}" 2>/dev/null || echo "No hay alarmas que eliminar"
      
        # TambiÃ©n eliminar por tags por si acaso
        aws cloudwatch describe-alarms \
          --region "{{ aws_region }}" \
          --query 'MetricAlarms[?contains(AlarmName, `{{ project_name }}`)].AlarmName' \
          --output text 2>/dev/null | \
        xargs -r aws cloudwatch delete-alarms \
          --alarm-names \
          --region "{{ aws_region }}" 2>/dev/null || echo "No hay mÃ¡s alarmas"
      register: alarms_cleanup

    - name: ğŸ—‘ï¸ 5. Eliminar instancias de prueba especÃ­ficas (por tags adicionales)
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        filters:
          "tag:Test": "auto-scaling-demo"
      register: instancias_prueba

    - name: ğŸš« TERMINAR instancias de prueba especÃ­ficas
      amazon.aws.ec2_instance:
        instance_ids: "{{ item.instance_id }}"
        region: "{{ aws_region }}"
        state: absent
        wait: yes
      loop: "{{ instancias_prueba.instances }}"
      when: instancias_prueba.instances | length > 0
      loop_control:
        label: "{{ item.instance_id }}"

    - name: â³ Esperar que termine toda la eliminaciÃ³n (2 minutos)
      pause:
        minutes: 2
        prompt: "Esperando que AWS complete TODAS las eliminaciones..."

    - name: ğŸ” Verificar instancias FINALES
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
        filters:
          "tag:Project": "{{ project_name }}"
          "instance-state-name": ["running", "stopped", "shutting-down"]
      register: instancias_finales

    - name: âœ… Verificar recursos reusables (solo lectura)
      shell: |
        echo "=== RECURSOS MANTENIDOS (SOLO LECTURA) ==="
        echo "VPC:"
        aws ec2 describe-vpcs --vpc-ids vpc-0711a0cc72ac117e9 --query 'Vpcs[0].VpcId' --region {{ aws_region }} --output text 2>/dev/null || echo "No existe"
        
        echo "Subnet:"
        aws ec2 describe-subnets --subnet-ids subnet-023c79b9799a5727d --query 'Subnets[0].SubnetId' --region {{ aws_region }} --output text 2>/dev/null || echo "No existe"
        
        echo "Security Group:"
        aws ec2 describe-security-groups --group-ids sg-069a74bb5438309c8 --query 'SecurityGroups[0].GroupId' --region {{ aws_region }} --output text 2>/dev/null || echo "No existe"
      register: kept_resources

    - debug:
        var: kept_resources.stdout

    - name: ğŸ“Š Resumen FINAL de limpieza
      debug:
        msg: |
          ğŸ‰ LIMPIEZA COMPLETA TERMINADA
          
          ğŸ“ˆ ESTADÃSTICAS:
          - Instancias encontradas inicialmente: {{ todas_instancias.instances | length }}
          - Instancias restantes FINALES: {{ instancias_finales.instances | length }}
          - Instancias ELIMINADAS: {{ todas_instancias.instances | length - instancias_finales.instances | length }}
          
          ğŸ—‘ï¸ RECURSOS ELIMINADOS:
          âœ“ Auto Scaling Group (forzado)
          âœ“ Launch Template
          âœ“ PolÃ­ticas de escalado
          âœ“ Alarmas de CloudWatch
          âœ“ TODAS las instancias del proyecto (running/stopped)
          âœ“ Instancias de prueba especÃ­ficas
          âœ“ Security Group antiguo (si no tenÃ­a dependencias)
          
          âœ… RECURSOS MANTENIDOS:
          - VPC y Subnet (infraestructura de red)
          - Security Group (reglas de firewall)
          
          ğŸš€ Ahora puedes ejecutar el playbook de despliegue nuevamente con un entorno COMPLETAMENTE limpio.