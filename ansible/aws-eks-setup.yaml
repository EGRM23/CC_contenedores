---
- name: üéØ Crear cluster EKS
  community.aws.eks_cluster:
    name: "{{ eks_cluster_name }}"
    version: "{{ eks_version }}"
    role_arn: "{{ eks_cluster_role_arn }}"
    subnets: "{{ subnet_ids }}"
    security_groups:
      - "{{ security_group_id }}"
    region: "{{ aws_region }}"
    wait: yes
    wait_timeout: 1800
  register: eks_cluster

- name: üîç DEBUG - Ver estructura de eks_cluster
  debug:
    var: eks_cluster

- name: üìù Guardar informaci√≥n del cluster
  set_fact:
    eks_cluster_endpoint: "{{ eks_cluster.endpoint }}"
    eks_cluster_ca: "{{ eks_cluster.certificate_authority.data }}"

- name: üßπ Limpiar node group existente si est√° en estado fallido
  shell: |
    aws eks delete-nodegroup \
      --cluster-name "{{ eks_cluster_name }}" \
      --nodegroup-name "{{ eks_nodegroup_name }}" \
      --region "{{ aws_region }}" 2>/dev/null || echo "No existe o ya fue eliminado"
  ignore_errors: yes
  register: cleanup_nodegroup

- name: ‚è≥ Esperar eliminaci√≥n de node group anterior
  pause:
    minutes: 2
    prompt: "Esperando que se elimine el node group anterior..."
  when: cleanup_nodegroup is defined

- name: üìù Crear node group
  community.aws.eks_nodegroup:
    cluster_name: "{{ eks_cluster_name }}"
    name: "{{ eks_nodegroup_name }}"
    subnets: "{{ subnet_ids }}"
    instance_types:
      - "{{ eks_instance_type }}"
    node_role: "{{ eks_nodegroup_role_arn }}"
    remote_access:
      ec2_ssh_key: "{{ key_name }}"
      source_sg: "{{ security_group_id }}"
    scaling_config:
      desired_size: "{{ eks_desired_size }}"
      min_size: "{{ eks_min_size }}"
      max_size: "{{ eks_max_size }}"
    region: "{{ aws_region }}"
    wait: yes
    wait_timeout: 600
  register: eks_nodegroup

- name: ‚úÖ Confirmar creaci√≥n del cluster
  debug:
    msg: |
      ‚úÖ Cluster EKS creado exitosamente:
      - Nombre: {{ eks_cluster_name }}
      - Endpoint: {{ eks_cluster_endpoint }}
      - Node Group: {{ eks_nodegroup_name }}
      - Estado: {{ eks_cluster.cluster.status }}